<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Bulk Renamer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .privacy-notice {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .settings {
            background: #f5f5f5;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .settings h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .info-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .preview {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #667eea;
            margin-top: 15px;
        }

        .preview strong {
            color: #667eea;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 30px 0;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.drag-over {
            background: #e8eaff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            display: block;
            margin: 20px auto;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .file-list {
            margin: 20px 0;
        }

        .file-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .file-item.processing {
            background: #fff3cd;
        }

        .file-item.success {
            background: #d4edda;
        }

        .file-item.error {
            background: #f8d7da;
        }

        .file-item.manual {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .manual-input {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 5px;
        }

        .manual-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .manual-input-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 1em;
        }

        .manual-input-row button {
            padding: 10px 25px;
            margin: 0;
            font-size: 1em;
        }

        .btn-skip {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
        }

        .preview-image {
            max-width: 100%;
            border: 2px solid #ddd;
            margin: 10px 0;
            border-radius: 5px;
            cursor: pointer;
        }

        .preview-image:hover {
            border-color: #667eea;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status-message {
            text-align: center;
            color: #666;
            font-weight: 500;
        }

        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            color: #666;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            cursor: pointer;
        }

        .image-modal img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 95%;
            max-height: 95%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÑ PDF Bulk Renamer</h1>
            <p class="subtitle">Extract text from PDFs & rename files automatically</p>
        </header>

        <div class="privacy-notice">
            üîí <strong>Secure & Private:</strong> All processing happens in your browser. Files never leave your computer.
        </div>

        <div class="warning-box">
            ‚ö†Ô∏è <strong>For scanned PDFs:</strong> Automatic text extraction may not work. You'll see a preview image and can manually enter the case number.
        </div>

        <div class="settings">
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="info-box">
                üí° <strong>Hungarian Patent Office Documents:</strong> Extracts √úgyiratsz√°m and adds to filename. Example: "original_name P2500316 .pdf"
            </div>

            <div class="setting-group">
                <label for="searchText">Search for Text Label (for digital PDFs)</label>
                <input type="text" id="searchText" value="√úgyiratsz√°m:" placeholder="Enter text to search for">
            </div>

            <div class="setting-group">
                <label>Extraction Pattern</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="patternCapital" name="pattern" value="capital" checked>
                        <label for="patternCapital">Capital letter + numbers (e.g., P2500316)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="patternAll" name="pattern" value="all">
                        <label for="patternAll">All text after label</label>
                    </div>
                </div>
            </div>

            <div class="setting-group">
                <label>Separator Character</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="sepSpace" name="separator" value=" " checked>
                        <label for="sepSpace">Space (allows double-click selection)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="sepUnderscore" name="separator" value="_">
                        <label for="sepUnderscore">Underscore (_)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="sepDash" name="separator" value="-">
                        <label for="sepDash">Dash (-)</label>
                    </div>
                </div>
            </div>

            <div class="setting-group">
                <label>Keep Original Extension</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="extYes" name="extension" value="yes" checked>
                        <label for="extYes">Yes (.pdf)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="extNo" name="extension" value="no">
                        <label for="extNo">No</label>
                    </div>
                </div>
            </div>

            <div class="preview">
                <strong>Preview:</strong> <span id="previewText">original_name P2500316 .pdf</span><br>
                <small style="color: #666;">Original name + separator + case number + separator + extension</small>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÑ</div>
            <h3>Click to upload or drag & drop PDF files</h3>
            <p style="color: #666; margin-top: 10px;">Support for multiple files</p>
            <input type="file" id="fileInput" accept=".pdf" multiple>
        </div>

        <div class="file-list" id="fileList"></div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="status-message" id="statusMessage"></div>
        </div>

        <button id="processBtn" disabled>Process PDFs</button>
        <button id="downloadBtn" style="display: none;">Download ZIP</button>

        <footer>
            <p>Made with ‚ù§Ô∏è for efficient document management</p>
        </footer>
    </div>

    <div id="imageModal" class="image-modal" onclick="this.style.display='none'">
        <img id="modalImage" src="" alt="PDF Preview">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let selectedFiles = [];
        let processedFiles = [];
        let fileResults = {};

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const processBtn = document.getElementById('processBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const statusMessage = document.getElementById('statusMessage');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(Array.from(e.target.files));
        });

        function handleFiles(files) {
            selectedFiles = files;
            fileResults = {};
            displayFileList();
            processBtn.disabled = files.length === 0;
            downloadBtn.style.display = 'none';
            processedFiles = [];
        }

        function displayFileList() {
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.id = `file-${index}`;
                div.innerHTML = `<span>üìÑ ${file.name}</span><span>${(file.size / 1024).toFixed(2)} KB</span>`;
                fileList.appendChild(div);
            });
        }

        async function extractTextFromPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1);
                
                const textContent = await page.getTextContent();
                
                console.log('Text content items:', textContent.items.length);
                
                if (textContent.items.length > 0) {
                    const viewport = page.getViewport({ scale: 1.0 });
                    const pageHeight = viewport.height;
                    const upperLeftItems = textContent.items.filter(item => {
                        return item.transform[5] > pageHeight * 0.6;
                    });
                    
                    return {
                        text: upperLeftItems.map(item => item.str).join(' '),
                        hasText: true
                    };
                } else {
                    // Scanned PDF - render preview of full first page
                    const scale = 1.5;
                    const viewport = page.getViewport({ scale });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    console.log('Canvas rendered, size:', canvas.width, 'x', canvas.height);

                    // Return full page image
                    const imageDataUrl = canvas.toDataURL('image/png');
                    console.log('Image data URL generated, length:', imageDataUrl.length);

                    return {
                        text: '',
                        hasText: false,
                        imageUrl: imageDataUrl
                    };
                }
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        function extractCaseNumber(text) {
            const searchText = document.getElementById('searchText').value;
            const pattern = document.querySelector('input[name="pattern"]:checked').value;

            const searchVariations = [
                searchText,
                '√úgyiratsz√°m:',
                'Ugyiratszam:',
                '√úgyiratszam',
            ];

            let searchIndex = -1;
            
            for (const variation of searchVariations) {
                searchIndex = text.indexOf(variation);
                if (searchIndex !== -1) break;
                
                const lowerText = text.toLowerCase();
                const lowerVariation = variation.toLowerCase();
                searchIndex = lowerText.indexOf(lowerVariation);
                if (searchIndex !== -1) break;
            }

            if (searchIndex === -1) return null;

            const afterLabel = text.substring(searchIndex + searchText.length);
            const lines = afterLabel.split(/[\n\r]+/);
            let caseNumberLine = '';
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.length > 0) {
                    caseNumberLine = trimmed;
                    break;
                }
            }

            if (!caseNumberLine) return null;

            if (pattern === 'capital') {
                let cleaned = caseNumberLine
                    .replace(/[^A-Z0-9\/\s]/gi, '')
                    .replace(/\s+/g, '')
                    .toUpperCase();
                
                const match = cleaned.match(/([A-Z]+\d+(?:\/\d+)?)/);
                return match ? match[1] : null;
            } else {
                return caseNumberLine.trim();
            }
        }

        function generateNewFilename(originalName, caseNumber) {
            const separator = document.querySelector('input[name="separator"]:checked').value;
            const keepExtension = document.querySelector('input[name="extension"]:checked').value === 'yes';
            
            const baseName = originalName.replace('.pdf', '');
            const extension = keepExtension ? '.pdf' : '';
            
            return `${baseName}${separator}${caseNumber}${separator}${extension}`;
        }

        function showManualInput(index, imageUrl) {
            const fileItem = document.getElementById(`file-${index}`);
            fileItem.classList.add('manual');
            
            console.log('showManualInput called with imageUrl:', imageUrl ? 'Image available' : 'No image');
            
            let html = `
                <div>
                    <strong>üìÑ ${selectedFiles[index].name}</strong><br>
                    <small style="color: #666;">‚ö†Ô∏è Scanned PDF detected. Please enter the case number manually:</small>
                </div>
            `;
            
            if (imageUrl) {
                console.log('Adding image to HTML, URL length:', imageUrl.length);
                html += `<img src="${imageUrl}" class="preview-image" alt="PDF preview" onclick="showImageModal('${imageUrl}')" title="Click to enlarge" onerror="console.error('Image failed to load')">`;
            } else {
                console.log('No imageUrl provided');
                html += `<div style="padding: 20px; background: #f0f0f0; text-align: center; margin: 10px 0; border-radius: 5px;">
                    <p>‚ö†Ô∏è Could not generate preview image</p>
                    <small>Please refer to the original PDF to find the case number</small>
                </div>`;
            }
            
            html += `
                <div class="manual-input">
                    <div class="manual-input-row">
                        <input type="text" id="manual-${index}" placeholder="Enter case number (e.g., P2500316)" autofocus>
                        <button onclick="applyManualInput(${index})">‚úì Apply</button>
                        <button onclick="skipFile(${index})" class="btn-skip">‚äó Skip</button>
                    </div>
                </div>
            `;
            
            fileItem.innerHTML = html;
            
            // Focus the input
            setTimeout(() => {
                const input = document.getElementById(`manual-${index}`);
                if (input) input.focus();
            }, 100);
        }

        window.showImageModal = function(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').style.display = 'block';
        };

        window.applyManualInput = function(index) {
            const input = document.getElementById(`manual-${index}`);
            const caseNumber = input.value.trim();
            
            if (!caseNumber) {
                alert('Please enter a case number');
                input.focus();
                return;
            }
            
            const file = selectedFiles[index];
            const newFilename = generateNewFilename(file.name, caseNumber);
            fileResults[index] = { file, newFilename, manual: true };
            
            const fileItem = document.getElementById(`file-${index}`);
            fileItem.classList.remove('manual');
            fileItem.classList.add('success');
            fileItem.innerHTML = `<span>‚úì ${file.name}</span><span>‚Üí ${newFilename}</span>`;
            
            checkAllProcessed();
        };

        window.skipFile = function(index) {
            const fileItem = document.getElementById(`file-${index}`);
            fileItem.classList.remove('manual');
            fileItem.classList.add('error');
            fileItem.innerHTML = `<span>‚äó ${selectedFiles[index].name}</span><span>Skipped</span>`;
            
            checkAllProcessed();
        };

        function checkAllProcessed() {
            const manualItems = document.querySelectorAll('.file-item.manual');
            if (manualItems.length === 0) {
                processedFiles = Object.values(fileResults);
                if (processedFiles.length > 0) {
                    downloadBtn.style.display = 'block';
                    statusMessage.textContent = `‚úì Ready to download ${processedFiles.length} file(s)`;
                } else {
                    statusMessage.textContent = `All files processed (${processedFiles.length} successful)`;
                }
            }
        }

        processBtn.addEventListener('click', async () => {
            processBtn.disabled = true;
            progressContainer.style.display = 'block';
            processedFiles = [];
            fileResults = {};

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const fileItem = document.getElementById(`file-${i}`);
                fileItem.classList.add('processing');

                try {
                    statusMessage.textContent = `Processing ${file.name}...`;
                    const result = await extractTextFromPDF(file);
                    
                    if (result.hasText) {
                        const caseNumber = extractCaseNumber(result.text);
                        
                        if (caseNumber) {
                            const newFilename = generateNewFilename(file.name, caseNumber);
                            fileResults[i] = { file, newFilename };
                            fileItem.classList.remove('processing');
                            fileItem.classList.add('success');
                            fileItem.innerHTML = `<span>‚úì ${file.name}</span><span>‚Üí ${newFilename}</span>`;
                        } else {
                            fileItem.classList.remove('processing');
                            showManualInput(i, null);
                        }
                    } else {
                        fileItem.classList.remove('processing');
                        showManualInput(i, result.imageUrl);
                    }
                } catch (error) {
                    fileItem.classList.remove('processing');
                    fileItem.classList.add('error');
                    fileItem.innerHTML = `<span>‚úó ${file.name}</span><span>Error: ${error.message}</span>`;
                }

                const progress = ((i + 1) / selectedFiles.length) * 100;
                progressFill.style.width = progress + '%';
                progressFill.textContent = Math.round(progress) + '%';
            }

            checkAllProcessed();
            processBtn.disabled = false;
        });

        downloadBtn.addEventListener('click', async () => {
            const zip = new JSZip();

            processedFiles.forEach(({ file, newFilename }) => {
                zip.file(newFilename, file);
            });

            statusMessage.textContent = 'Creating ZIP file...';
            const blob = await zip.generateAsync({ 
                type: 'blob',
                compression: "DEFLATE",
                compressionOptions: { level: 6 }
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'renamed_pdfs.zip';
            a.click();
            URL.revokeObjectURL(url);
            
            statusMessage.textContent = '‚úì Download started!';
        });

        document.querySelectorAll('input[name="separator"], input[name="extension"]').forEach(input => {
            input.addEventListener('change', updatePreview);
        });

        function updatePreview() {
            const separator = document.querySelector('input[name="separator"]:checked').value;
            const keepExtension = document.querySelector('input[name="extension"]:checked').value === 'yes';
            const extension = keepExtension ? '.pdf' : '';
            document.getElementById('previewText').textContent = 
                `original_name${separator}P2500316${separator}${extension}`;
        }
    </script>
</body>
</html>
